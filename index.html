<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ö–∏—Ç–∞—è</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
      margin: 0;
    }
    h2 {
      color: #ff3333;
      text-align: center;
    }
    input, button {
      margin: 8px 0;
      width: 100%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ff3333;
      border-radius: 5px;
      background: #333;
      color: #fff;
      box-sizing: border-box;
    }
    input[readonly] {
      background: #555;
    }
    input[type="file"] {
      padding: 3px;
    }
    button {
      background: #ff3333;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #cc0000;
    }
    .delete-btn {
      background: #555;
    }
    .delete-btn:hover {
      background: #777;
    }
    hr {
      border-color: #ff3333;
      margin: 15px 0;
    }
    .loader {
      display: none;
      text-align: center;
      color: #ff3333;
      margin-top: 10px;
    }
    .item {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ff3333;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h2>–ó–∞–∫–∞–∑ —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ –ö–∏—Ç–∞—è</h2>
  <input id="username" placeholder="–í–∞—à –Ω–∏–∫ (–∞–≤—Ç–æ)" readonly><br><br>

  <div id="items"></div>
  <button onclick="addItem()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button><br><br>
  <button onclick="submitForm()">üì• –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –±–ª–∞–Ω–∫</button>
  <div class="loader" id="loader">–û—Ç–ø—Ä–∞–≤–∫–∞...</div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const usernameInput = document.getElementById("username");
    const username = tg.initDataUnsafe?.user?.username || tg.initDataUnsafe?.user?.first_name || 'anonymous';
    usernameInput.value = username;
    const chatId = tg.initDataUnsafe?.user?.id || null;

    function addItem() {
      const div = document.createElement('div');
      div.className = 'item';
      const id = Date.now();

      div.innerHTML = `
        <input placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (–æ–±—É–≤—å, —à–æ—Ä—Ç—ã...)" class="name">
        <input placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç" class="link">
        <input placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞" class="contactPhoto" readonly>
        <input type="file" accept="image/*" class="contactPhotoFile" data-id="${id}-contact">
        <input placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞" class="photo" readonly>
        <input type="file" accept="image/*" class="photoFile" data-id="${id}-photo">
        <input placeholder="–†–∞–∑–º–µ—Ä" class="size">
        <input placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ" class="qty" type="number" min="1">
        <input placeholder="–¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É (—é–∞–Ω–∏)" class="price" type="number" min="0" step="0.01">
        <button class="delete-btn" onclick="this.parentElement.remove()">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
        <hr>
      `;
      document.getElementById('items').appendChild(div);

      const fileInputs = [
        { input: div.querySelector('.photoFile'), output: div.querySelector('.photo'), type: 'photo' },
        { input: div.querySelector('.contactPhotoFile'), output: div.querySelector('.contactPhoto'), type: 'contact' }
      ];

      fileInputs.forEach(({ input, output, type }) => {
        input.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append('image', file);

          try {
            const res = await fetch('https://order-miniapp.onrender.com/upload-photo', {
              method: 'POST',
              body: formData
            });

            const data = await res.json();
            if (data.url) {
              output.value = data.url;
            } else {
              alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ${type === 'photo' ? '—Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞' : '—Ñ–æ—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞'}: ${data.error}`);
            }
          } catch (error) {
            alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ${type === 'photo' ? '—Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞' : '—Ñ–æ—Ç–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞'}: ${error.message}`);
          }
        });
      });
    }

    async function submitForm() {
      try {
        document.getElementById('loader').style.display = 'block';
        const itemDivs = document.querySelectorAll('#items > div');
        const items = Array.from(itemDivs).map(div => ({
          name: div.querySelector('.name').value,
          link: div.querySelector('.link').value,
          contactPhoto: div.querySelector('.contactPhoto').value,
          photo: div.querySelector('.photo').value,
          size: div.querySelector('.size').value,
          qty: div.querySelector('.qty').value,
          price: div.querySelector('.price').value
        }));

        for (let item of items) {
          if (!item.name || !item.link || !item.size || !item.qty || !item.price) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (–∫—Ä–æ–º–µ —Ñ–æ—Ç–æ)!');
            return;
          }
        }

        if (!chatId) {
          alert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à Telegram ID');
          return;
        }

        const res = await fetch('https://order-miniapp.onrender.com/submit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, chat_id: chatId, items })
        });

        if (!res.ok) {
          const errorData = await res.json();
          throw new Error(errorData.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä');
        }

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${username}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();

        alert('–ë–ª–∞–Ω–∫ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Telegram!');
      } catch (error) {
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message);
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Ç–æ–≤–∞—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    addItem();
  </script>
</body>
</html>